{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/srivastand/Desktop/practiseProjects/Elfsod/frontend/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\nimport { cookies } from 'next/headers'\nimport https from 'https'\n\nexport async function createClient() {\n  // Check environment variables first\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n  if (!supabaseUrl || !supabaseKey) {\n    throw new Error('Supabase environment variables not configured. Please check NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY in .env.local');\n  }\n\n  try {\n    const cookieStore = await cookies();\n\n    // Create a custom fetch that handles SSL properly\n    // The Supabase client will use this for all requests\n    const customFetch = (url: string, options: RequestInit = {}) => {\n      // For Node.js environments, we need to ensure SSL certificates are verified\n      // The @supabase/ssr client should handle this, but we can add extra configuration\n      return fetch(url, {\n        ...options,\n        // Node.js fetch (18+) should handle SSL automatically\n        // If issues persist, we can add agent configuration here\n      });\n    };\n\n    return createServerClient(\n      supabaseUrl,\n      supabaseKey,\n      {\n        cookies: {\n          getAll() {\n            return cookieStore.getAll()\n          },\n          setAll(cookiesToSet) {\n            try {\n              cookiesToSet.forEach(({ name, value, options }) =>\n                cookieStore.set(name, value, options)\n              )\n            } catch {\n              // The `setAll` method was called from a Server Component.\n              // This can be ignored if you have middleware refreshing\n              // user sessions.\n            }\n          },\n        },\n        // Note: @supabase/ssr handles fetch internally, but we can configure it\n        // if needed. The SSL issue is typically resolved by ensuring Node.js\n        // has access to system certificates.\n      }\n    );\n  } catch (error) {\n    console.error('Error creating Supabase server client:', error);\n    throw error;\n  }\n}\n\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAGO,eAAe;IACpB,oCAAoC;IACpC,MAAM;IACN,MAAM;IAEN;;IAIA,IAAI;QACF,MAAM,cAAc,MAAM,IAAA,4IAAO;QAEjC,kDAAkD;QAClD,qDAAqD;QACrD,MAAM,cAAc,CAAC,KAAa,UAAuB,CAAC,CAAC;YACzD,4EAA4E;YAC5E,kFAAkF;YAClF,OAAO,MAAM,KAAK;gBAChB,GAAG,OAAO;YAGZ;QACF;QAEA,OAAO,IAAA,iMAAkB,EACvB,aACA,aACA;YACE,SAAS;gBACP;oBACE,OAAO,YAAY,MAAM;gBAC3B;gBACA,QAAO,YAAY;oBACjB,IAAI;wBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;oBAEjC,EAAE,OAAM;oBACN,0DAA0D;oBAC1D,wDAAwD;oBACxD,iBAAiB;oBACnB;gBACF;YACF;QAIF;IAEJ,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,0CAA0C;QACxD,MAAM;IACR;AACF"}},
    {"offset": {"line": 97, "column": 0}, "map": {"version":3,"sources":["file:///Users/srivastand/Desktop/practiseProjects/Elfsod/frontend/app/api/categories/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { createClient } from '@/lib/supabase/server';\n\n/**\n * Next.js API route to fetch categories\n * GET /api/categories?city=Mumbai\n */\nexport async function GET(request: Request) {\n  try {\n    // Get city parameter from query string\n    const { searchParams } = new URL(request.url);\n    const city = searchParams.get('city');\n\n    let supabase;\n    try {\n      supabase = await createClient();\n    } catch (clientError) {\n      console.error('❌ Failed to create Supabase client:', clientError);\n      return NextResponse.json({\n        success: false,\n        error: 'Failed to connect to database',\n        message: 'Please check your Supabase configuration. Frontend will try direct connection.',\n        fallback: true\n      }, { status: 500 });\n    }\n\n    let data, error;\n    try {\n      // First, fetch all categories\n      const categoriesResult = await supabase\n        .from('categories')\n        .select('*')\n        .order('name', { ascending: true });\n      \n      if (categoriesResult.error) {\n        throw categoriesResult.error;\n      }\n      \n      const categories = categoriesResult.data || [];\n      \n      // Count ad spaces per category, filtered by location if city is provided\n      // Logic: category + location = count of cards that will show\n      const countsMap: Record<string, number> = {};\n      \n      for (const cat of categories) {\n        // Build query with category filter\n        let query = supabase\n          .from('ad_spaces')\n          .select('*', { count: 'exact', head: true })\n          .eq('category_id', cat.id)\n          .eq('availability_status', 'available');\n        \n        // If city is provided, filter by location\n        if (city) {\n          // Join with locations table to filter by city\n          // We need to use a different approach since Supabase doesn't support joins in count queries\n          // Instead, we'll fetch location_ids for the city first, then count\n          const { data: locations } = await supabase\n            .from('locations')\n            .select('id')\n            .eq('city', city);\n          \n          if (locations && locations.length > 0) {\n            const locationIds = locations.map(loc => loc.id);\n            query = query.in('location_id', locationIds);\n          } else {\n            // No locations found for this city, count is 0\n            countsMap[cat.id] = 0;\n            continue;\n          }\n        }\n        \n        const { count, error: countError } = await query;\n        \n        if (!countError) {\n          countsMap[cat.id] = count || 0;\n        } else {\n          countsMap[cat.id] = 0;\n        }\n      }\n      \n      // For parent categories, also count child category ad spaces\n      // This implements: Filter by parent category (gets all child categories)\n      const parentCountsMap: Record<string, number> = {};\n      categories.forEach((cat: any) => {\n        if (cat.parent_category_id === null) {\n          // This is a parent category - count all child categories' ad spaces\n          const childCategories = categories.filter((c: any) => c.parent_category_id === cat.id);\n          let totalCount = countsMap[cat.id] || 0;\n          childCategories.forEach((child: any) => {\n            totalCount += countsMap[child.id] || 0;\n          });\n          parentCountsMap[cat.id] = totalCount;\n        }\n      });\n      \n      // Add counts to categories\n      // Parent categories show sum of their children + their own\n      // Child categories show only their own count\n      data = categories.map((cat: any) => ({\n        ...cat,\n        ad_space_count: cat.parent_category_id === null \n          ? (parentCountsMap[cat.id] || countsMap[cat.id] || 0)\n          : (countsMap[cat.id] || 0)\n      }));\n      \n      error = null;\n    } catch (fetchError) {\n      // Handle fetch/network errors (like SSL certificate issues)\n      console.error('❌ Supabase fetch error (likely SSL/network issue):', fetchError);\n      return NextResponse.json({\n        success: false,\n        error: 'Failed to fetch categories',\n        message: fetchError instanceof Error ? fetchError.message : String(fetchError),\n        fallback: true, // Signal frontend to use direct service\n        details: 'Server-side connection failed. Frontend will use direct browser connection.'\n      }, { status: 500 });\n    }\n\n    if (error) {\n      console.error('❌ Supabase query error:', error);\n      return NextResponse.json({\n        success: false,\n        error: 'Database query failed',\n        details: error.message\n      }, { status: 500 });\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: data || [],\n      count: data?.length || 0\n    });\n\n  } catch (error) {\n    console.error('API error:', error);\n    return NextResponse.json({\n      success: false,\n      error: 'Internal server error',\n      message: error instanceof Error ? error.message : String(error)\n    }, { status: 500 });\n  }\n}\n\n/**\n * Create a new category\n * POST /api/categories\n * Body: {\n *   name: string,\n *   description?: string,\n *   icon_url?: string\n * }\n */\nexport async function POST(request: Request) {\n  try {\n    let supabase;\n    try {\n      supabase = await createClient();\n    } catch (clientError) {\n      console.error('❌ Failed to create Supabase client:', clientError);\n      return NextResponse.json({\n        success: false,\n        error: 'Failed to connect to database',\n        message: 'Please check your Supabase configuration.',\n      }, { status: 500 });\n    }\n\n    const body = await request.json();\n    const { name, description, icon_url } = body;\n\n    if (!name || !name.trim()) {\n      return NextResponse.json({\n        success: false,\n        error: 'Category name is required'\n      }, { status: 400 });\n    }\n\n    // Check if category already exists\n    const { data: existing } = await supabase\n      .from('categories')\n      .select('id, name')\n      .eq('name', name.trim())\n      .maybeSingle();\n\n    if (existing) {\n      return NextResponse.json({\n        success: false,\n        error: 'Category already exists',\n        data: existing\n      }, { status: 400 });\n    }\n\n    // Create category\n    const { data: newCategory, error: insertError } = await supabase\n      .from('categories')\n      .insert({\n        name: name.trim(),\n        description: description?.trim() || null,\n        icon_url: icon_url || null\n      })\n      .select()\n      .single();\n\n    if (insertError) {\n      console.error('❌ Error creating category:', insertError);\n      return NextResponse.json({\n        success: false,\n        error: 'Failed to create category',\n        details: insertError.message\n      }, { status: 500 });\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: newCategory,\n      message: 'Category created successfully'\n    }, { status: 201 });\n\n  } catch (error) {\n    console.error('API error:', error);\n    return NextResponse.json({\n      success: false,\n      error: 'Internal server error',\n      message: error instanceof Error ? error.message : String(error)\n    }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}